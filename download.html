<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Ожидание оплаты</title>

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin="anonymous" />

	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


	<style type="text/css">

		.background {
			object-fit: cover;
  			width: 100vw;
  			height: 100vh;
  			position: fixed;
  			top: 0;
  			left: 0;
		}

		.form {
			margin-top: 5%;


		}

		.waitingPay {
			padding: 2vw;
		    height: 100vh;
		    max-width: 500px;
		    text-align: center;
		}

		
		}
	</style>

</head>
<body>


<video autoplay muted loop class="background">
  <source src="bg3.mp4" type="video/mp4">
</video>

<div class="background">
	<div class="waitingPay text-white mx-auto">
		  <div id="orderId" class="alert alert-warning mx-auto" role="alert" style="max-width: 500px;" data-template="Ваш номер заказа: %s"> 
		  	
		  </div>

		  <div class="form-group statusPay">
			  <div class="spinner-border mx-auto" role="status" aria-hidden="true"></div>
			  <strong>Проверяем вашу оплату. Как только заказ будет оплачен вы будете перенаправлены на страницу загрузки</strong>

			  <div class="alert bg-light text-dark rounded-0" role="alert" style="margin-top: 5px">
			  	Если в течении 3 минут после оплаты вы все еще видите эту надпись пожалуйста напишите нам на почту <strong class="text-dark">haveacess@gmail.com</strong> и укажите <strong>свой номер заказа.</strong> Как правило мы отвечаем в течении 24 часов
			  </div>
		  </div>
	</div>
</div>

<script type="text/javascript">
	//Инфоис получаем из гет запроса. Устанавливаем при помощи темплате как айди заказа
	//Чекаем инфоис - и если валиден - открываем ссылку довнлоад URL (не забывать парсить)

	window.onload = function() {

		var service_uri = 'https://haveacess.beget.tech/api.php';
		let decomposeLink = new URL(window.location.href);
		var invoice_id = decomposeLink.searchParams.get('invoice_id');
		console.log('invoice_id: ', invoice_id);

		if (!invoice_id) {
			//set no detected order
			$('#orderId').html('Не найден ваш заказ. Если вы уже оплатили: просьба отправить чек об оплате нам на почту: <strong>haveacess@gmail.com</strong>');
			$('.waitingPay').find('.statusPay').addClass('d-none');
			return; //say bye bye
		}

		if (invoice_id) {
			//set order number
			let template = $('#orderId').attr('data-template');
			$('#orderId').html(template.replace('%s', invoice_id));
		}

		var invoice_ping = setInterval(function () {

			//if condition. . clearInterval(invoice_ping);

			let data = JSON.stringify({id_invoice: invoice_id});
			$.post(service_uri, {'action': 'file.download', data: data}, function(response) {

				let info = JSON.parse(response);
				console.log('pay status: ', info.ok);
				
				if (info.ok == true) {
					clearInterval(invoice_ping); //stop ping
					window.location.href = info.download_link; //redirect to download file
				}
			});


		}, 5000);

	}

	

	// let data = JSON.stringify({product: "itunes", ip: ip_address, price: $('#amount').val()  });
 //  	//send hint
	// $.post(service_uri, {'action': 'invoice.create', data: data}, function(response) {
	// 	$('#goPay').attr('disabled', false);
	// 	console.log('invoice.create response: ', response);
	// 	let status = JSON.parse(response);

	//   	if (status.ok == true) {
	//   		//new blank
	//   		let link = document.createElementNS("http://www.w3.org/1999/xhtml", "a");
	// 	    link.href = status.invoice;
	// 	    link.target = '_blank';
	// 	    link.click(); //emulate click

	// 	    //find invoice_id in link
	// 	    let decomposeLink = new URL(status.invoice);
	// 	    let invoice_id = decomposeLink.searchParams.get('billId');

	//   		window.location.href = download_uri + '?invoice_id=' + invoice_id;
	//   	}
	// });
</script>

</body>
</html>
